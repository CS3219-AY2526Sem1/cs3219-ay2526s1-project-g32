version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
  user:
    build: ./user_service
    environment:
      NODE_ENV: ${USER_SERVICE_NODE_ENV:-development}
      PORT: ${USER_SERVICE_PORT:-4001}
      CORS_ALLOWED_ORIGINS: ${USER_SERVICE_CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      INTERNAL_SERVICE_KEY: ${USER_SERVICE_INTERNAL_KEY:-dev-internal-key}
    ports:
      - "${USER_SERVICE_PORT:-4001}:${USER_SERVICE_PORT:-4001}"
    healthcheck:
      test: ["CMD-SHELL", "node -e 'const http=require(\"http\");http.get(\"http://localhost:${USER_SERVICE_PORT:-4001}/\",r=>process.exit(r.statusCode>=200&&r.statusCode<400?0:1))'" ]
      interval: 30s
      timeout: 5s
      retries: 3

  question:
    build: ./question_service
    environment:
      NODE_ENV: ${QUESTION_SERVICE_NODE_ENV:-development}
      PORT: ${QUESTION_SERVICE_PORT:-4003}
      CORS_ALLOWED_ORIGINS: ${QUESTION_SERVICE_CORS_ALLOWED_ORIGINS:-http://localhost:3000}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      SUPABASE_JWT_SECRET: ${SUPABASE_JWT_SECRET}
      LOG_LEVEL: ${QUESTION_SERVICE_LOG_LEVEL:-debug}
    ports:
      - "${QUESTION_SERVICE_PORT:-4003}:${QUESTION_SERVICE_PORT:-4003}"
    healthcheck:
      test: ["CMD-SHELL", "node -e 'const http=require(\"http\");http.get(\"http://localhost:${QUESTION_SERVICE_PORT:-4003}/health\",r=>process.exit(r.statusCode>=200&&r.statusCode<400?0:1))'" ]
      interval: 30s
      timeout: 5s
      retries: 3

  matching:
    build: ./matching_service
    ports:
      - "${MATCHING_SERVICE_PORT:-3002}:${MATCHING_SERVICE_PORT:-3002}"
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      NODE_ENV: ${MATCHING_SERVICE_NODE_ENV:-development}
      PORT: ${MATCHING_SERVICE_PORT:-3002}
      RABBITMQ_URL: ${RABBITMQ_URL:-amqp://rabbitmq:5672}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      USER_SERVICE_URL: ${MATCHING_USER_SERVICE_URL:-http://user:4001}
      COLLABORATION_SERVICE_URL: ${MATCHING_COLLABORATION_SERVICE_URL:-http://collaboration:4010/api/v1/sessions}
    healthcheck:
      test: ["CMD-SHELL", "node -e 'const http=require(\"http\");http.get(\"http://localhost:${MATCHING_SERVICE_PORT:-3002}/\",r=>process.exit(r.statusCode>=200&&r.statusCode<400?0:1))'" ]
      interval: 30s
      timeout: 5s
      retries: 3

  collaboration:
    build: ./collaboration_service
    ports:
      - "${COLLABORATION_SERVICE_PORT:-4010}:${COLLABORATION_SERVICE_PORT:-4010}"
    environment:
      NODE_ENV: ${COLLABORATION_SERVICE_NODE_ENV:-development}
      PORT: ${COLLABORATION_SERVICE_PORT:-4010}
      HOST: ${COLLABORATION_SERVICE_HOST:-0.0.0.0}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      QUESTION_SERVICE_URL: ${COLLAB_QUESTION_SERVICE_URL:-http://question:4003/api/v1}
      USER_SERVICE_URL: ${COLLAB_USER_SERVICE_URL:-http://user:4001/api/v1}
      USER_SERVICE_INTERNAL_KEY: ${USER_SERVICE_INTERNAL_KEY:-dev-internal-key}
      JWT_SECRET: ${COLLABORATION_JWT_SECRET:-dev-change-me}
      SESSION_TOKEN_TTL_SECONDS: ${COLLABORATION_SESSION_TOKEN_TTL_SECONDS:-300}
      SESSION_GRACE_PERIOD_SECONDS: ${COLLABORATION_SESSION_GRACE_PERIOD_SECONDS:-300}
      COLLAB_WS_BASE_URL: ${COLLAB_WS_BASE_URL:-ws://localhost:4010/collab}
      LOG_LEVEL: ${COLLABORATION_SERVICE_LOG_LEVEL:-debug}
    depends_on:
      redis:
        condition: service_healthy
      question:
        condition: service_started
      user:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "node -e 'const http=require(\"http\");http.get(\"http://localhost:${COLLABORATION_SERVICE_PORT:-4010}/\",r=>process.exit(r.statusCode>=200&&r.statusCode<400?0:1))'" ]
      interval: 30s
      timeout: 5s
      retries: 3

  frontend:
    build: ./frontend
    ports:
      - "${FRONTEND_PORT:-3000}:${FRONTEND_PORT:-3000}"
    environment:
      PORT: ${FRONTEND_PORT:-3000}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://user:4001}
      NEXT_PUBLIC_USER_SERVICE_URL: ${NEXT_PUBLIC_USER_SERVICE_URL:-http://user:4001/api/v1}
      NEXT_PUBLIC_MATCHING_SERVICE_URL: ${NEXT_PUBLIC_MATCHING_SERVICE_URL:-http://matching:3002/api/v1/matching}
      NEXT_PUBLIC_QUESTION_SERVICE_URL: ${NEXT_PUBLIC_QUESTION_SERVICE_URL:-http://question:4003/api/v1/questions}
      NEXT_PUBLIC_COLLAB_SERVICE_URL: ${NEXT_PUBLIC_COLLAB_SERVICE_URL:-http://collaboration:4010/api/v1}
      NEXT_PUBLIC_COLLAB_WS_URL: ${NEXT_PUBLIC_COLLAB_WS_URL:-ws://collaboration:4010/collab}
      NEXT_PUBLIC_VERIFY_REDIRECT: ${NEXT_PUBLIC_VERIFY_REDIRECT:-http://localhost:3000/verify-success}
      NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
    depends_on:
      - user
      - collaboration
      - matching
      - question
    healthcheck:
      test: ["CMD-SHELL", "node -e 'const http=require(\"http\");http.get(\"http://localhost:${FRONTEND_PORT:-3000}/\",r=>process.exit(r.statusCode>=200&&r.statusCode<400?0:1))'" ]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  collaboration_node_modules: {}
  user_node_modules: {}
  matching_node_modules: {}
  question_node_modules: {}
  frontend_node_modules: {}
  # (volumes for node_modules are declared in docker-compose.override.yml, where they are used)
